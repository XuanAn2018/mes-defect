<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MES Defect Reporting - B√°o C√°o L·ªói S·∫£n Xu·∫•t</title>
  <style>
    :root {
      --primary: #dc3545;
      --primary-light: #e74c3c;
      --primary-dark: #c0392b;
      --success: #28a745;
      --warning: #ffc107;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --gray: #6c757d;
      --border-radius: 8px;
      --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
      margin: 0; 
      padding: 20px; 
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 800px; 
      margin: 0 auto; 
      background: white;
      padding: 30px; 
      border-radius: 12px;
      box-shadow: var(--box-shadow);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }
    
    h1 { 
      color: var(--primary); 
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      color: var(--gray);
      margin-bottom: 15px;
    }
    
    .card {
      background: var(--light);
      border-radius: var(--border-radius);
      padding: 25px;
      margin-bottom: 25px;
      border-left: 4px solid var(--primary);
    }
    
    .card-title {
      font-weight: 600;
      margin-top: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label { 
      font-weight: 600; 
      display: block; 
      margin-bottom: 8px;
      color: var(--dark);
    }
    
    input, select, textarea, button {
      width: 100%; 
      margin: 6px 0; 
      padding: 12px; 
      border-radius: var(--border-radius);
      border: 1px solid #ddd; 
      font-size: 15px;
      transition: var(--transition);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    button {
      background: var(--primary); 
      color: white; 
      border: none; 
      font-weight: 600;
      cursor: pointer; 
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover { 
      background: var(--primary-light); 
    }
    
    button:disabled { 
      background: var(--gray); 
      cursor: not-allowed;
    }
    
    .btn-success { background: var(--success); }
    .btn-info { background: var(--info); }
    
    .help-text {
      font-size: 0.85rem;
      color: var(--gray);
      margin-top: 5px;
    }
    
    .required::after {
      content: " *";
      color: var(--primary);
    }
    
    .preview-image {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
      border-radius: var(--border-radius);
      display: none;
    }
    
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    
    .alert {
      padding: 15px;
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: none;
    }
    
    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .alert-error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .defect-item {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      margin: 5px 0;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .defect-item:hover {
      background: #e9ecef;
      border-color: var(--primary);
    }
    
    .defect-item.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary-dark);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üö® MES Defect Reporting</h1>
      <p class="subtitle">C√¥ng c·ª• b√°o c√°o l·ªói s·∫£n xu·∫•t v·ªõi h√¨nh ·∫£nh</p>
    </div>

    <div class="card">
      <h3 class="card-title">‚öôÔ∏è C·∫•u H√¨nh</h3>
      
      <div class="form-group">
        <label for="endpoint" class="required">Endpoint URL:</label>
        <input type="url" id="endpoint" value="https://your-defect-worker.workers.dev" placeholder="https://your-worker.workers.dev">
        <div class="help-text">ƒê·ªãa ch·ªâ API endpoint cho Defect Reporting</div>
      </div>
      
      <div class="form-group">
        <label for="apiKey" class="required">API Key:</label>
        <input type="password" id="apiKey" placeholder="Nh·∫≠p API key c·ªßa b·∫°n" value="mes_user1_pk2024">
        <div class="help-text">Li√™n h·ªá qu·∫£n tr·ªã vi√™n ƒë·ªÉ l·∫•y API Key</div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">üìù Th√¥ng Tin L·ªói</h3>
      
      <div class="form-group">
        <label for="package" class="required">Package:</label>
        <input type="text" id="package" placeholder="M_XXX-XXXX_X_XXXXXXXXXXXXXXXX_XX" value="M_HAR-0207_1_HAR0300RGL001001_01_02">
      </div>
      
      <div class="form-group">
        <label for="opserial">Operation Serial:</label>
        <input type="number" id="opserial" placeholder="0" value="0">
      </div>
      
      <div class="form-group">
        <label class="required">Ch·ªçn Lo·∫°i L·ªói:</label>
        <button type="button" id="loadDefects" class="btn-info">üìã T·∫£i Danh S√°ch L·ªói</button>
        <div id="defectsList" class="form-group" style="display: none;">
          <div class="help-text">Click ƒë·ªÉ ch·ªçn lo·∫°i l·ªói:</div>
          <div id="defectsContainer" style="max-height: 200px; overflow-y: auto; margin-top: 10px;"></div>
        </div>
      </div>
      
      <div class="form-group">
        <label for="comment">Ghi Ch√∫:</label>
        <textarea id="comment" placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ l·ªói..."></textarea>
      </div>
      
      <div class="form-group">
        <label for="image">H√¨nh ·∫¢nh Minh H·ªça:</label>
        <input type="file" id="image" accept="image/*">
        <div class="help-text">T·∫£i l√™n h√¨nh ·∫£nh minh h·ªça l·ªói (t√πy ch·ªçn)</div>
        <img id="imagePreview" class="preview-image" alt="Preview">
      </div>
    </div>

    <div id="alert" class="alert"></div>

    <div class="form-group">
      <button id="submitReport" class="btn-success">üöÄ G·ª≠i B√°o C√°o L·ªói</button>
    </div>

    <div id="result" style="display: none;">
      <h3>üìã K·∫øt Qu·∫£:</h3>
      <pre id="resultContent"></pre>
    </div>
  </div>

  <script>
  let selectedDefect = null;
  let defectsList = [];

  // Hi·ªÉn th·ªã th√¥ng b√°o
  function showAlert(message, type = 'success') {
    const alert = document.getElementById('alert');
    alert.textContent = message;
    alert.className = `alert alert-${type}`;
    alert.style.display = 'block';
    
    setTimeout(() => {
      alert.style.display = 'none';
    }, 5000);
  }

  // Hi·ªÉn th·ªã ·∫£nh preview
  document.getElementById('image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('imagePreview');
    
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    } else {
      preview.style.display = 'none';
    }
  });

  // T·∫£i danh s√°ch l·ªói
  document.getElementById('loadDefects').addEventListener('click', async function() {
    const endpoint = document.getElementById('endpoint').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();
    const package = document.getElementById('package').value.trim();
    
    if (!endpoint || !apiKey || !package) {
      showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß endpoint, API key v√† package!', 'error');
      return;
    }

    try {
      this.textContent = '‚è≥ ƒêang t·∫£i...';
      this.disabled = true;

      const url = `${endpoint}/api/defects?package=${encodeURIComponent(package)}&apikey=${encodeURIComponent(apiKey)}`;
      const response = await fetch(url);
      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'L·ªói khi t·∫£i danh s√°ch l·ªói');
      }

      defectsList = data.data || [];
      displayDefectsList(defectsList);
      
      document.getElementById('defectsList').style.display = 'block';
      showAlert(`ƒê√£ t·∫£i ${defectsList.length} lo·∫°i l·ªói`);

    } catch (error) {
      showAlert('L·ªói: ' + error.message, 'error');
      console.error('Load defects error:', error);
    } finally {
      this.textContent = 'üìã T·∫£i Danh S√°ch L·ªói';
      this.disabled = false;
    }
  });

  // Hi·ªÉn th·ªã danh s√°ch l·ªói
  function displayDefectsList(defects) {
    const container = document.getElementById('defectsContainer');
    container.innerHTML = '';

    defects.forEach(defect => {
      const div = document.createElement('div');
      div.className = 'defect-item';
      div.textContent = defect.display;
      div.addEventListener('click', () => selectDefect(defect, div));
      container.appendChild(div);
    });
  }

  // Ch·ªçn l·ªói
  function selectDefect(defect, element) {
    // B·ªè ch·ªçn t·∫•t c·∫£
    document.querySelectorAll('.defect-item').forEach(item => {
      item.classList.remove('selected');
    });
    
    // Ch·ªçn item hi·ªán t·∫°i
    element.classList.add('selected');
    selectedDefect = defect;
    
    showAlert(`ƒê√£ ch·ªçn: ${defect.display}`);
  }

  // G·ª≠i b√°o c√°o l·ªói
  document.getElementById('submitReport').addEventListener('click', async function() {
    const endpoint = document.getElementById('endpoint').value.trim();
    const apiKey = document.getElementById('apiKey').value.trim();
    const package = document.getElementById('package').value.trim();
    const opserial = document.getElementById('opserial').value.trim();
    const comment = document.getElementById('comment').value.trim();
    const imageFile = document.getElementById('image').files[0];

    if (!endpoint || !apiKey || !package) {
      showAlert('Vui l√≤ng nh·∫≠p endpoint, API key v√† package!', 'error');
      return;
    }

    if (!selectedDefect) {
      showAlert('Vui l√≤ng ch·ªçn lo·∫°i l·ªói!', 'error');
      return;
    }

    try {
      this.textContent = '‚è≥ ƒêang g·ª≠i...';
      this.disabled = true;
      document.body.classList.add('loading');

      const formData = new FormData();
      formData.append('package', package);
      formData.append('opserial', opserial || '0');
      formData.append('defect_cat', selectedDefect.cat_code);
      formData.append('defect_code', selectedDefect.defect_code);
      formData.append('comment', comment);
      if (imageFile) {
        formData.append('image', imageFile);
      }

      const url = `${endpoint}/api/report?apikey=${encodeURIComponent(apiKey)}`;
      const response = await fetch(url, {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'L·ªói khi g·ª≠i b√°o c√°o');
      }

      // Hi·ªÉn th·ªã k·∫øt qu·∫£
      document.getElementById('resultContent').textContent = JSON.stringify(result, null, 2);
      document.getElementById('result').style.display = 'block';
      
      showAlert('‚úÖ B√°o c√°o l·ªói ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng! Defect ID: ' + result.defect_id);

      // Reset form
      setTimeout(() => {
        document.getElementById('comment').value = '';
        document.getElementById('image').value = '';
        document.getElementById('imagePreview').style.display = 'none';
        selectedDefect = null;
        document.querySelectorAll('.defect-item').forEach(item => {
          item.classList.remove('selected');
        });
      }, 2000);

    } catch (error) {
      showAlert('L·ªói: ' + error.message, 'error');
      console.error('Submit report error:', error);
    } finally {
      this.textContent = 'üöÄ G·ª≠i B√°o C√°o L·ªói';
      this.disabled = false;
      document.body.classList.remove('loading');
    }
  });

  // Kh·ªüi t·∫°o
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Defect Reporting App initialized');
  });
  </script>
</body>
</html>
